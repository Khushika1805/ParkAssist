<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ParkAssist ‚Äî Live Campus Parking</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <!-- PapaParse (CSV parsing) -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    .alert-card { border: 1px solid var(--border-color); box-shadow: var(--shadow); background: var(--bg-card); }
    .alert-row { background-color: var(--bg-secondary); }
    .pulse-dot { width: 8px; height: 8px; border-radius: 9999px; background: #10B981; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%{opacity:.7} 50%{opacity:0.2} 100%{opacity:.7} }


    :root {
      --bg-primary: #FFFFFF;
      --bg-secondary: #F8F9FA;
      --bg-card: #FFFFFF;
      --text-primary: #1F2937;
      --text-secondary: #6B7280;
      --border-color: #E5E7EB;
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    }
    .dark {
      --bg-primary: #111827;
      --bg-secondary: #1F2937;
      --bg-card: #374151;
      --text-primary: #F9FAFB;
      --text-secondary: #D1D5DB;
      --border-color: #4B5563;
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.3), 0 1px 2px -1px rgb(0 0 0 / 0.3);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.3), 0 4px 6px -4px rgb(0 0 0 / 0.3);
    }
    body { background-color: var(--bg-primary); color: var(--text-primary); }
    .card {
      background-color: var(--bg-card);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow);
    }
    .chip { border: 1px solid var(--border-color); }
    .badge { font-size: 0.75rem; padding: 0.2rem 0.6rem; border-radius: 9999px; border-width: 1px; }
    .badge-available { color: #065F46; background: #ECFDF5; border-color: #A7F3D0; }
    .badge-limited   { color: #92400E; background: #FFFBEB; border-color: #FDE68A; }
    .badge-full      { color: #991B1B; background: #FEF2F2; border-color: #FECACA; }
    .pill { border-radius: 9999px; }
    .divider { border-color: var(--border-color); }
    .subtle { color: var(--text-secondary); }
    .btn { border-radius: 9999px; padding: 0.5rem 0.85rem; }
    .btn-amber { background: #F59E0B; color: white; }
    .btn-ghost { background: transparent; color: var(--text-secondary); }
    .leaflet-container { border-radius: 0.5rem; }
    .marker-dot {
      width: 24px; height: 24px; border-radius: 50%; border: 3px solid white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3); display:flex; align-items:center; justify-content:center;
    }
    .marker-center { width:8px; height:8px; background:white; border-radius:50%; }
    .progress { width: 100%; height: 12px; background: #E5E7EB; border-radius: 9999px; overflow: hidden; }
  </style>
</head>
<body>
  <!-- HEADER -->
  <header class="sticky top-0 z-10 border-b" style="background-color: var(--bg-primary); border-color: var(--border-color)">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img
            src="./parkingLogo.png"  
            alt="ParkAssist logo"
            class="w-8 h-8 rounded-lg object-contain"
            />
        <div>
          <h1 class="text-lg font-bold">ParkAssist</h1>
          <p class="text-xs subtle">Live Campus Parking</p>
        </div>
      </div>
      <button id="themeToggle" class="btn btn-ghost rounded-full" title="Toggle theme">üåì</button>
    </div>
  </header>

  <!-- MAP -->
  <section class="max-w-6xl mx-auto px-4 pt-4">
    <div id="map" class="w-full h-72"></div>
  </section>

  <!-- CONTROLS -->
  <section class="max-w-6xl mx-auto px-4 pt-4">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <input id="searchInput" type="text" placeholder="Search parking lots..." class="w-full md:w-1/2 chip pill px-4 py-2 bg-transparent"/>
      <div class="flex items-center gap-2">
        <button data-filter="all" class="chip pill px-3 py-1 text-sm">All</button>
        <button data-filter="available" class="chip pill px-3 py-1 text-sm text-green-600">Available</button>
        <button data-filter="limited" class="chip pill px-3 py-1 text-sm text-yellow-600">Limited</button>
        <button data-filter="full" class="chip pill px-3 py-1 text-sm text-red-600">Full</button>
        <button id="favToggle" class="chip pill px-3 py-1 text-sm">‚≠ê Favorites</button>
      </div>
    </div>
  </section>

  <!-- ALERTS HEADER -->
<section class="max-w-6xl mx-auto px-4 pt-2">
  <div class="flex items-center justify-between">
    <div>
      <h2 class="text-xl font-bold" style="color: var(--text-primary);">Parking Alerts</h2>
      <p class="text-sm subtle">Get notified when parking becomes available</p>
    </div>
    <button id="newAlertBtn" class="btn btn-amber">Ôºã New Alert</button>
  </div>
</section>

<!-- ACTIVE ALERTS -->
<section class="max-w-6xl mx-auto px-4 pt-3">
  <h3 class="text-lg font-semibold mb-3" style="color: var(--text-primary);">
    Active Alerts <span id="activeCount" class="subtle text-sm">(0)</span>
  </h3>
  <div id="activeAlerts" class="space-y-3"></div>
</section>

<!-- ALERT HISTORY -->
<section class="max-w-6xl mx-auto px-4 pt-4">
  <h3 class="text-lg font-semibold mb-3" style="color: var(--text-primary);">Recent Activity</h3>
  <div id="alertHistory" class="space-y-2"></div>
</section>

<!-- CREATE ALERT MODAL -->
<div id="alertModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
  <div class="rounded-xl p-6 max-w-md w-full card" style="box-shadow: var(--shadow-lg);">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-bold" style="color: var(--text-primary);">Create Alert</h2>
      <button id="closeAlertModal" class="btn btn-ghost rounded-full text-xl">‚úï</button>
    </div>

    <form id="alertForm" class="space-y-4">
      <div>
        <label class="flex items-center gap-2 mb-2">
          <span>Parking Lot</span>
        </label>
        <select id="alertLot" class="chip pill px-3 py-2 w-full bg-transparent"></select>
      </div>

      <div>
        <label class="flex items-center gap-2 mb-2">
          <span>Minimum Free Spaces</span>
        </label>
        <input id="alertThreshold" type="number" min="1" value="5" class="chip pill px-3 py-2 w-full bg-transparent" />
        <p class="text-xs mt-1 subtle">You'll be notified when this many spaces become available</p>
      </div>

      <div class="flex justify-end gap-3 pt-2">
        <button type="button" id="cancelAlert" class="btn btn-ghost">Cancel</button>
        <button type="submit" class="btn btn-amber">Create Alert</button>
      </div>
    </form>
  </div>
</div>


  <!-- LIST -->
  <section class="max-w-6xl mx-auto px-4 py-4">
    <div id="list" class="space-y-3"></div>
  </section>

  <script>
    // --- Theme toggler ---
    const themeToggle = document.getElementById('themeToggle');
    let isDark = false;
    function applyTheme() {
      document.documentElement.classList.toggle('dark', isDark);
      // Switch the base map tiles for dark/light
      if (window._tileLayer) {
        const url = isDark
          ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
          : 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';
        window._tileLayer.setUrl(url);
      }
    }
    themeToggle.addEventListener('click', () => {
      isDark = !isDark;
      applyTheme();
    });
        // ====== ALERTS: schema & storage ======
    // Stored in localStorage under this key
    const LS_ALERTS_KEY = 'parking_alerts_v1';

    // Alert object:
    // { id, lot_name, threshold_spaces, is_active, triggered_at, created_date }
    let alerts = []; // state we keep in memory

    function loadAlertsFromStorage() {
        try {
        const raw = localStorage.getItem(LS_ALERTS_KEY);
        alerts = raw ? JSON.parse(raw) : [];
        } catch {
        alerts = [];
        }
    }
    function saveAlertsToStorage() {
        localStorage.setItem(LS_ALERTS_KEY, JSON.stringify(alerts));
    }

    function formatDate(dt) {
        if (!dt) return 'Never';
        const d = new Date(dt);
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    }

    // --- Map ---
    const mapCenter = [39.2543, -76.7114]; // UMBC campus center
    const map = L.map('map', { zoomControl: true }).setView(mapCenter, 15);
    const tileUrlLight = 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';
    const tileUrlDark  = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
    window._tileLayer = L.tileLayer(tileUrlLight, {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/attributions">CARTO</a>'
    }).addTo(map);

    function statusForLot(lot) {
      const total = Number(lot.total_spaces || 100);
      const occ   = Number(lot.occupied_spaces || 0);
      const rate  = total > 0 ? occ / total : 0;
      if (rate >= 0.9) return 'full';
      if (rate >= 0.7) return 'limited';
      return 'available';
    }
    function freeSpaces(lot) {
      const total = Number(lot.total_spaces || 100);
      const occ   = Number(lot.occupied_spaces || 0);
      return Math.max(0, total - occ);
    }
    function markerColor(status) {
      return status === 'available' ? '#10B981' : status === 'limited' ? '#F59E0B' : '#EF4444';
    }
    function makeDivIcon(status) {
      const color = markerColor(status);
      return L.divIcon({
        html: '<div class="marker-dot" style="background:'+color+'"><div class="marker-center"></div></div>',
        className: 'custom-parking-marker',
        iconSize: [24,24],
        iconAnchor: [12,12],
        popupAnchor: [0,-12]
      });
    }

    // --- Data & state ---
    let allLots = [];
    let markers = [];
    let filter = 'all';
    let showFavs = false;
    let searchTerm = '';

    const searchInput = document.getElementById('searchInput');
    const favToggle = document.getElementById('favToggle');
    const listEl = document.getElementById('list');
    document.querySelectorAll('[data-filter]').forEach(btn => {
      btn.addEventListener('click', () => {
        filter = btn.getAttribute('data-filter');
        render();
      });
    });
    favToggle.addEventListener('click', () => { showFavs = !showFavs; favToggle.classList.toggle('bg-amber-50'); render(); });
    searchInput.addEventListener('input', (e) => { searchTerm = e.target.value.toLowerCase(); render(); });

    function clearMarkers() {
      markers.forEach(m => map.removeLayer(m));
      markers = [];
    }

    function renderMap(lots) {
      clearMarkers();
      lots.forEach(lot => {
        const st = statusForLot(lot);
        const m = L.marker([Number(lot.lat), Number(lot.lng)], { icon: makeDivIcon(st) })
          .addTo(map)
          .bindPopup(`
            <div class="text-center">
              <div class="font-semibold text-sm">${lot.name}</div>
              <div class="text-xs subtle mt-1">${freeSpaces(lot)}/${lot.total_spaces || 100} Free</div>
              <div class="text-xs mt-1 ${st==='available'?'text-green-600':st==='limited'?'text-yellow-600':'text-red-600'}">
                ${st==='available'?'Available':st==='limited'?'Limited':'Full'}
              </div>
            </div>
          `);
        markers.push(m);
      });
    }

    function badgeClass(st) {
      return st==='available' ? 'badge badge-available' : st==='limited' ? 'badge badge-limited' : 'badge badge-full';
    }

    function renderList(lots) {
      if (!lots.length) {
        listEl.innerHTML = `
          <div class="text-center py-12 card rounded-xl subtle">No parking lots match your criteria</div>
        `;
        return;
      }
      listEl.innerHTML = lots.map(lot => {
        const st = statusForLot(lot);
        const free = freeSpaces(lot);
        const total = Number(lot.total_spaces || 100);
        const occPct = total ? Math.round(((total - free)/total)*100) : 0;
        return `
        <div class="card rounded-xl p-4 cursor-pointer hover:scale-[1.01] transition" onclick="focusLot('${lot.id}')">
          <div class="flex items-start justify-between gap-3">
            <div class="flex-1">
              <div class="flex items-center gap-2">
                <span class="text-sm subtle">üìç</span>
                <h3 class="font-semibold text-lg">${lot.name}</h3>
              </div>
              <div class="mt-2 flex items-center gap-4">
                <div class="flex items-center gap-2">
                  <span class="text-2xl font-bold">${free}</span>
                  <span class="subtle">/${total} Free</span>
                </div>
                <span class="${badgeClass(st)}">${st==='available'?'Available':st==='limited'?'Limited':'Full'}</span>
              </div>
              <div class="mt-3 flex items-center gap-2 subtle text-xs">‚è± Updated 2 min ago</div>
            </div>
            <button class="btn btn-ghost" onclick="toggleFavorite(event, '${lot.id}')">${lot.is_favorite ? '‚≠ê' : '‚òÜ'}</button>
          </div>
          <div class="mt-4">
            <div class="flex items-center justify-between mb-2">
              <span class="font-medium">Capacity</span>
              <span class="subtle text-sm">${total - free} occupied</span>
            </div>
            <div class="progress">
              <div style="height:100%; width:${occPct}%; background:${st==='available'?'#10B981':st==='limited'?'#F59E0B':'#EF4444'}"></div>
            </div>
          </div>
        </div>`;
      }).join('');
    }

      function renderActiveAlerts() {
    const active = alerts.filter(a => a.is_active);
    document.getElementById('activeCount').textContent = `(${active.length})`;

    const host = document.getElementById('activeAlerts');
    if (!active.length) {
      host.innerHTML = `
        <div class="text-center py-8 rounded-xl border border-dashed subtle">
          No active alerts
        </div>`;
      return;
    }

    host.innerHTML = active.map(a => `
      <div class="alert-card rounded-xl p-4">
        <div class="flex items-start justify-between">
          <div class="flex-1">
            <div class="flex items-center gap-2 mb-2">
              <span class="subtle">üìç</span>
              <h3 class="font-semibold" style="color: var(--text-primary);">${a.lot_name}</h3>
            </div>
            <div class="text-sm subtle">Alert when ${a.threshold_spaces}+ spaces free</div>
            <div class="flex items-center gap-2 mt-2 text-xs subtle">
              ‚è± Last triggered: ${formatDate(a.triggered_at)}
            </div>
          </div>
          <div class="flex items-center gap-2">
            <span class="pulse-dot"></span>
            <button class="btn btn-ghost rounded-full text-red-600" onclick="deleteAlert('${a.id}')">üóë</button>
          </div>
        </div>
      </div>
    `).join('');
  }

      function evaluateAlerts(currentLots) {
    const active = alerts.filter(a => a.is_active);
    if (!active.length) return;

    let changed = false;
    for (const a of active) {
      const lot = currentLots.find(l => (l.name || '').toLowerCase() === a.lot_name.toLowerCase());
      if (!lot) continue;
      const free = freeSpaces(lot);
      if (free >= Number(a.threshold_spaces || 0)) {
        // mark triggered time
        a.triggered_at = new Date().toISOString();
        changed = true;

        // Optional: show a simple in-page toast (no browser permission needed)
        showToast(`${a.lot_name} has ${free} free (‚â• ${a.threshold_spaces})`);
      }
    }
    if (changed) {
      saveAlertsToStorage();
      renderAlertHistory();
      renderActiveAlerts();
    }
  }

  // simple toast
  function showToast(msg) {
    const t = document.createElement('div');
    t.textContent = msg;
    t.className = 'fixed bottom-5 left-1/2 -translate-x-1/2 px-4 py-2 rounded-lg card';
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 2500);
  }


    function renderAlertHistory() {
    const history = alerts
        .filter(a => a.triggered_at)          // any alert that has been triggered at least once
        .sort((a,b) => (new Date(b.triggered_at||0)) - (new Date(a.triggered_at||0)))
        .slice(0, 5);

    const host = document.getElementById('alertHistory');
    if (!history.length) {
        host.innerHTML = `<div class="text-center py-4 text-sm subtle">No recent activity</div>`;
        return;
    }

    host.innerHTML = history.map(a => `
        <div class="alert-row flex items-center gap-3 p-3 rounded-lg">
        <span class="text-green-600">‚úî</span>
        <div class="flex-1 min-w-0">
            <p class="text-sm font-medium" style="color: var(--text-primary);">
            ${a.lot_name} now has ${a.threshold_spaces}+ spaces
            </p>
            <div class="flex items-center gap-1 text-xs subtle">
            ‚è± <span>${formatDate(a.triggered_at)}</span>
            </div>
        </div>
        </div>
    `).join('');
    }

  // expose minimal API for delete
  window.deleteAlert = function(id) {
    alerts = alerts.filter(a => a.id !== id);
    saveAlertsToStorage();
    renderActiveAlerts();
    renderAlertHistory();
    evaluateAlerts(lots);
  };


    window.focusLot = function(id) {
      const lot = allLots.find(l => l.id == id);
      if (!lot) return;
      map.setView([Number(lot.lat), Number(lot.lng)], 16, { animate: true });
    };

    window.toggleFavorite = function(e, id) {
      e.stopPropagation();
      const i = allLots.findIndex(l => l.id == id);
      if (i >= 0) {
        allLots[i].is_favorite = !allLots[i].is_favorite;
        render();
      }
    };

    function applyFilters() {
      return allLots.filter(lot => {
        const matchesSearch = String(lot.name || '').toLowerCase().includes(searchTerm);
        const matchesFav = !showFavs || !!lot.is_favorite;
        let matchesStatus = true;
        if (filter !== 'all') matchesStatus = statusForLot(lot) === filter;
        return matchesSearch && matchesFav && matchesStatus;
      });
    }

    function render() {
      const lots = applyFilters();
      renderMap(lots);
      renderList(lots);
      renderActiveAlerts();
    }

      // ====== ALERT MODAL WIRING ======
  const modalEl = document.getElementById('alertModal');
  const newAlertBtn = document.getElementById('newAlertBtn');
  const closeAlertModal = document.getElementById('closeAlertModal');
  const cancelAlert = document.getElementById('cancelAlert');
  const alertForm = document.getElementById('alertForm');

  function openModal() { modalEl.classList.remove('hidden'); modalEl.classList.add('flex'); }
  function closeModal() { modalEl.classList.add('hidden'); modalEl.classList.remove('flex'); }

  newAlertBtn.addEventListener('click', openModal);
  closeAlertModal.addEventListener('click', closeModal);
  cancelAlert.addEventListener('click', closeModal);

  alertForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const lotName = (document.getElementById('alertLot').value || '').trim();
    const threshold = Number(document.getElementById('alertThreshold').value || 0);
    if (!lotName || !threshold) return;

    const alertObj = {
      id: `a-${Date.now()}`,
      lot_name: lotName,
      threshold_spaces: threshold,
      is_active: true,
      triggered_at: null,
      created_date: new Date().toISOString()
    };
    alerts.push(alertObj);
    saveAlertsToStorage();
    renderActiveAlerts();
    renderAlertHistory();
    closeModal();
  });

  // on load
  loadAlertsFromStorage();

    

    // Try to load ParkingLot_export.csv from same folder as index.html
    async function loadCSV() {
      try {
        const res = await fetch('ParkingLot_export.csv', { cache: 'no-store' });
        if (!res.ok) throw new Error('CSV not found');
        const text = await res.text();
        const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
        const rows = parsed.data.map((r, idx) => ({
          id: r.id || String(idx+1),
          name: r.name || r.lot_name || 'Lot',
          lat: parseFloat(r.lat),
          lng: parseFloat(r.lng),
          total_spaces: r.total_spaces ? Number(r.total_spaces) : (r.total || 100),
          occupied_spaces: r.occupied_spaces ? Number(r.occupied_spaces) : (r.occupied || 0),
          is_favorite: String(r.is_favorite || '').toLowerCase() === 'true'
        })).filter(r => !Number.isNaN(r.lat) && !Number.isNaN(r.lng));
        if (!rows.length) throw new Error('No valid rows');
        allLots = rows;
      } catch (e) {
        console.warn('Falling back to inline sample data:', e.message);
        allLots = [
          { id: '1', name: 'Administration Drive Garage', lat: 39.2555, lng: -76.7131, total_spaces: 180, occupied_spaces: 125, is_favorite: true },
          { id: '2', name: 'Lot 1',                       lat: 39.2534, lng: -76.7138, total_spaces: 120, occupied_spaces: 45,  is_favorite: false },
          { id: '3', name: 'Commons Garage',              lat: 39.2564, lng: -76.7102, total_spaces: 300, occupied_spaces: 280, is_favorite: false },
          { id: '4', name: 'Stadium Lot',                 lat: 39.2499, lng: -76.7139, total_spaces: 200, occupied_spaces: 80,  is_favorite: false }
        
        ];
      }
    function populateAlertLotSelect() {
    const sel = document.getElementById('alertLot');
    if (!sel) return;
    sel.innerHTML = allLots
      .map(l => `<option value="${(l.name ?? '').replace(/"/g,'&quot;')}">${l.name}</option>`)
      .join('');
    }
    populateAlertLotSelect();

      render();
    }

    loadCSV();

  </script>
</body>
</html>